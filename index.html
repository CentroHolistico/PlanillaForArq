<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Control Horario - Obra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-visible { opacity: 1; pointer-events: auto; }
        .modal-content-hidden { transform: translateY(-50px) scale(0.95); }
        .modal-content-visible { transform: translateY(0) scale(1); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .tab-active { border-color: #4f46e5; color: #4f46e5; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-full mx-auto">
        <!-- Encabezado -->
        <header class="mb-8 p-4 bg-white rounded-lg shadow-md no-print">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Planilla de Control Horario</h1>
                    <p id="current-date" class="text-gray-500 text-sm md:text-base">Cargando...</p>
                </div>
                <div class="text-center md:text-right mt-4 md:mt-0">
                    <p class="text-xs text-gray-400">ID de Sesión:</p>
                    <p id="user-id" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">Cargando...</p>
                </div>
            </div>
        </header>

        <!-- Controles Principales -->
        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 no-print">
            <button id="check-in-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-timer"></i><span>Marcar Ingreso</span></button>
            <button id="early-checkout-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-user-minus"></i><span>Salida Anticipada</span></button>
            <button id="add-worker-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-user-plus"></i><span>Agregar Personal</span></button>
            <button id="create-report-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-file-text"></i><span>Crear Reporte</span></button>
            <button id="management-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-shield-warning"></i><span>Gerencia</span></button>
        </div>

        <!-- Resumen de Totales -->
        <div class="mb-6 p-4 bg-white rounded-lg shadow-md no-print">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Resumen General</h2>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Costo Total Estimado Acumulado:</span>
                <span id="grand-total-display" class="text-2xl font-bold text-green-600">$0.00</span>
            </div>
        </div>

        <!-- Tabla de Obreros -->
        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100 no-print">
                    <tr>
                        <th scope="col" class="p-4"><input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"></th>
                        <th scope="col" class="px-4 py-3">Obrero</th>
                        <th scope="col" class="px-4 py-3">Categoría</th>
                        <th scope="col" class="px-4 py-3 text-center">Horas del Día</th>
                        <th scope="col" class="px-4 py-3 text-center">Horas Totales</th>
                        <th scope="col" class="px-4 py-3 text-right">Precio / Hr</th>
                        <th scope="col" class="px-4 py-3 text-right">Total Acumulado</th>
                        <th scope="col" class="px-4 py-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="workers-table-body">
                     <tr id="loading-row"><td colspan="8" class="text-center p-8"><div class="flex justify-center items-center space-x-2 text-gray-500"><i class="ph ph-circle-notch text-2xl animate-spin"></i><span>Cargando datos...</span></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modales -->
    <div id="add-worker-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content modal-content-hidden">
            <form id="add-worker-form" class="p-6"><h2 class="text-2xl font-bold mb-6">Agregar Personal</h2><div class="mb-4"><label for="name" class="block text-sm font-bold mb-2">Nombre Completo:</label><input type="text" id="name" name="name" class="shadow border rounded w-full py-2 px-3" required></div><div class="mb-4"><label for="role" class="block text-sm font-bold mb-2">Cargo:</label><select id="role" name="role" class="shadow border rounded w-full py-2 px-3" required><option value="Ayudante">Ayudante</option><option value="Medio Oficial">Medio Oficial</option><option value="Oficial">Oficial</option><option value="Oficial Especializado">Oficial Especializado</option></select></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="dni" class="block text-sm font-bold mb-2">DNI/CUIL:</label><input type="text" id="dni" name="dni" class="shadow border rounded w-full py-2 px-3"></div><div><label for="hourlyRate" class="block text-sm font-bold mb-2">Precio por Hora ($):</label><input type="number" id="hourlyRate" name="hourlyRate" step="0.01" class="shadow border rounded w-full py-2 px-3" required></div></div><div class="mb-6"><label for="email" class="block text-sm font-bold mb-2">Correo:</label><input type="email" id="email" name="email" class="shadow border rounded w-full py-2 px-3"></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-add-worker" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar</button></div></form>
        </div>
    </div>
    <div id="edit-worker-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content modal-content-hidden">
            <form id="edit-worker-form" class="p-6"><h2 class="text-2xl font-bold mb-6">Editar Personal</h2><input type="hidden" id="edit-worker-id"><div class="mb-4"><label for="edit-name" class="block text-sm font-bold mb-2">Nombre Completo:</label><input type="text" id="edit-name" name="name" class="shadow border rounded w-full py-2 px-3" required></div><div class="mb-4"><label for="edit-role" class="block text-sm font-bold mb-2">Cargo:</label><select id="edit-role" name="role" class="shadow border rounded w-full py-2 px-3" required><option value="Ayudante">Ayudante</option><option value="Medio Oficial">Medio Oficial</option><option value="Oficial">Oficial</option><option value="Oficial Especializado">Oficial Especializado</option></select></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="edit-dni" class="block text-sm font-bold mb-2">DNI/CUIL:</label><input type="text" id="edit-dni" name="dni" class="shadow border rounded w-full py-2 px-3"></div><div><label for="edit-hourlyRate" class="block text-sm font-bold mb-2">Precio por Hora ($):</label><input type="number" id="edit-hourlyRate" name="hourlyRate" step="0.01" class="shadow border rounded w-full py-2 px-3" required></div></div><div class="mb-6"><label for="edit-email" class="block text-sm font-bold mb-2">Correo:</label><input type="email" id="edit-email" name="email" class="shadow border rounded w-full py-2 px-3"></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-edit-worker" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button></div></form>
        </div>
    </div>
    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content modal-content-hidden">
            <form id="password-form" class="p-6"><h2 id="password-title" class="text-2xl font-bold mb-4">Acción Protegida</h2><p class="text-sm text-gray-600 mb-6">Por favor, introduce la contraseña para continuar.</p>
            <div>
                <label for="password" class="block text-sm font-bold mb-2">Contraseña:</label>
                <div class="relative">
                    <input type="password" id="password" name="password" class="shadow border rounded w-full py-2 px-3 pr-10" required>
                    <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                        <i id="password-icon" class="ph ph-eye"></i>
                    </button>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancel-password" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></form>
        </div>
    </div>
    <div id="management-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content modal-content-hidden flex flex-col" style="height: 90vh;">
            <div class="p-4 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Panel de Gerencia</h2>
                    <p class="text-sm text-gray-600">Ajuste manual de registros.</p>
                </div>
                <button id="adjust-selected-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2" disabled>
                    <i class="ph ph-wrench"></i>
                    <span>Ajustar Seleccionado</span>
                </button>
            </div>
            <div id="management-worker-list" class="p-6 overflow-y-auto flex-grow">
            </div>
             <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="button" id="close-management-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>
     <div id="adjustment-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content modal-content-hidden">
            <form id="adjustment-detail-form" class="p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">Ajuste Detallado de Registro</h2>
                        <p id="adjust-detail-worker-name" class="text-gray-600 mb-4"></p>
                    </div>
                    <div class="w-48">
                         <label for="adjustment-date-selector" class="block text-sm font-bold mb-2">Seleccionar Fecha:</label>
                         <select id="adjustment-date-selector" class="shadow border rounded w-full py-2 px-3"></select>
                    </div>
                </div>
                <input type="hidden" id="adjust-detail-worker-id">
                <div class="mt-6 p-4 border rounded-lg">
                    <h3 class="font-bold mb-3">Ajustes Generales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="adjust-hours-day" class="block text-sm font-bold mb-2">Horas del Día (HH:MM)</label>
                            <input type="text" id="adjust-hours-day" placeholder="Ej: 08:30" class="shadow border rounded w-full py-2 px-3">
                        </div>
                        <div>
                            <label for="adjust-lateness" class="block text-sm font-bold mb-2">Total Minutos de Retraso</label>
                            <input type="number" id="adjust-lateness" class="shadow border rounded w-full py-2 px-3">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancel-adjustment-detail" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg">Aplicar Ajustes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="early-checkout-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content modal-content-hidden">
            <form id="early-checkout-form" class="p-6">
                <h2 class="text-2xl font-bold mb-4">Salida Anticipada</h2>
                <p class="text-sm text-gray-600 mb-6">Selecciona el personal y especifica el motivo.</p>
                <div class="flex justify-between items-center p-2 border-b mb-2">
                    <label for="select-all-early-checkout" class="flex items-center space-x-2 text-sm font-semibold">
                        <input type="checkbox" id="select-all-early-checkout" class="h-4 w-4 text-orange-600 rounded">
                        <span>Seleccionar Todos</span>
                    </label>
                </div>
                <div id="early-checkout-worker-list" class="mb-4 max-h-60 overflow-y-auto rounded-lg p-1 space-y-2"></div>
                <div class="mb-6"><label for="checkout-reason" class="block text-sm font-bold mb-2">Motivo:</label><textarea id="checkout-reason" name="checkout-reason" rows="3" class="shadow border rounded w-full py-2 px-3" required></textarea></div>
                <div class="flex justify-end space-x-4"><button type="button" id="cancel-early-checkout" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div>
            </form>
        </div>
    </div>
    <div id="report-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl modal-content modal-content-hidden flex flex-col" style="height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center no-print">
                 <div>
                    <h2 class="text-3xl font-bold">Reporte General</h2>
                    <p id="report-date-range" class="text-gray-500"></p>
                </div>
                <button type="button" id="close-report-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
            <div id="report-body" class="p-6 md:p-8 overflow-y-auto flex-grow">
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-4 no-print">
                 <button type="button" id="download-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2"><i class="ph ph-file-csv"></i><span>Descargar CSV</span></button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content"><div class="p-6 text-center"><div id="alert-icon" class="mx-auto mb-4"></div><h3 id="alert-title" class="text-lg font-medium mb-2"></h3><p id="alert-message" class="text-sm text-gray-500"></p><div class="mt-6"><button id="alert-ok-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Entendido</button></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDocs, onSnapshot, updateDoc, deleteDoc, serverTimestamp, Timestamp, writeBatch, arrayUnion, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBmqG6_pD7OzSGhOaZSRc4IVfXwNaADE8U",
          authDomain: "planilla-c17ab.firebaseapp.com",
          projectId: "planilla-c17ab",
          storageBucket: "planilla-c17ab.appspot.com",
          messagingSenderId: "993902505533",
          appId: "1:993902505533:web:9154f4bd2c95e088c78454"
        };
        
        const appId = 'planilla-c17ab';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserId = null;
        let workersData = [];
        let dailyProcessFlags = { morning: false, evening: false };
        let pendingAction = { type: null, workerId: null };
        let currentReportData = { range: null, data: [] };
        let dailyRecordsCache = {};

        const el = (id) => document.getElementById(id);
        const workersTableBody = el('workers-table-body');
        const loadingRow = el('loading-row');
        const selectAllCheckbox = el('select-all-checkbox');
        const addWorkerBtn = el('add-worker-btn');
        const checkInBtn = el('check-in-btn');
        const earlyCheckoutBtn = el('early-checkout-btn');
        const createReportBtn = el('create-report-btn');
        const managementBtn = el('management-btn');
        const currentDateEl = el('current-date');
        const userIdEl = el('user-id');
        const grandTotalDisplay = el('grand-total-display');
        const addWorkerModal = el('add-worker-modal');
        const cancelAddWorkerBtn = el('cancel-add-worker');
        const addWorkerForm = el('add-worker-form');
        const editWorkerModal = el('edit-worker-modal');
        const cancelEditWorkerBtn = el('cancel-edit-worker');
        const editWorkerForm = el('edit-worker-form');
        const passwordModal = el('password-modal');
        const passwordTitle = el('password-title');
        const cancelPasswordBtn = el('cancel-password');
        const passwordForm = el('password-form');
        const togglePasswordBtn = el('toggle-password-btn');
        const passwordInput = el('password');
        const passwordIcon = el('password-icon');
        const earlyCheckoutModal = el('early-checkout-modal');
        const cancelEarlyCheckoutBtn = el('cancel-early-checkout');
        const earlyCheckoutForm = el('early-checkout-form');
        const earlyCheckoutWorkerList = el('early-checkout-worker-list');
        const selectAllEarlyCheckout = el('select-all-early-checkout');
        const managementModal = el('management-modal');
        const closeManagementBtn = el('close-management-btn');
        const managementWorkerList = el('management-worker-list');
        const adjustSelectedBtn = el('adjust-selected-btn');
        const adjustmentDetailModal = el('adjustment-detail-modal');
        const cancelAdjustmentDetailBtn = el('cancel-adjustment-detail');
        const adjustmentDetailForm = el('adjustment-detail-form');
        const adjustmentDateSelector = el('adjustment-date-selector');
        const reportModal = el('report-modal');
        const downloadCsvBtn = el('download-csv-btn');
        const alertModal = el('alert-modal');
        const alertOkBtn = el('alert-ok-btn');
        const alertTitle = el('alert-title');
        const alertMessage = el('alert-message');
        const alertIcon = el('alert-icon');
        const closeReportBtn = el('close-report-btn');
        const reportDateRange = el('report-date-range');
        const reportBody = el('report-body');
        
        function showAlert(title, message, type = 'info') {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            const icons = { success: '<i class="ph ph-check-circle text-4xl text-green-500"></i>', error: '<i class="ph ph-x-circle text-4xl text-red-500"></i>', info: '<i class="ph ph-info text-4xl text-blue-500"></i>' };
            alertIcon.innerHTML = icons[type] || icons['info'];
            toggleModal(alertModal, true);
        }
        alertOkBtn.addEventListener('click', () => toggleModal(alertModal, false));

        function formatTime(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00";
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount || 0);
        }
        function dateToYYYYMMDD(date) {
            return date.toISOString().split('T')[0];
        }

        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            currentDateEl.textContent = now.toLocaleDateString('es-ES', options);
        }

        function toggleModal(modal, visible) {
            const content = modal.querySelector('.modal-content');
            if (visible) {
                modal.classList.add('modal-visible');
                modal.classList.remove('modal-hidden');
                content.classList.add('modal-content-visible');
                content.classList.remove('modal-content-hidden');
            } else {
                modal.classList.add('modal-hidden');
                modal.classList.remove('modal-visible');
                content.classList.add('modal-content-hidden');
                content.classList.remove('modal-content-visible');
            }
        }
        
        addWorkerBtn.addEventListener('click', () => toggleModal(addWorkerModal, true));
        cancelAddWorkerBtn.addEventListener('click', () => { toggleModal(addWorkerModal, false); addWorkerForm.reset(); });
        cancelEditWorkerBtn.addEventListener('click', () => { toggleModal(editWorkerModal, false); editWorkerForm.reset(); });
        cancelPasswordBtn.addEventListener('click', () => { toggleModal(passwordModal, false); passwordForm.reset(); });
        cancelAdjustmentDetailBtn.addEventListener('click', () => { toggleModal(adjustmentDetailModal, false); });
        createReportBtn.addEventListener('click', () => generateReport());
        downloadCsvBtn.addEventListener('click', () => generateAndDownloadCSV());
        closeReportBtn.addEventListener('click', () => toggleModal(reportModal, false));
        
        earlyCheckoutBtn.addEventListener('click', () => {
            const activeWorkers = workersData.filter(w => w.checkedIn);
            if (activeWorkers.length === 0) return showAlert('Información', 'No hay ningún obrero en turno.', 'info');
            earlyCheckoutWorkerList.innerHTML = '';
            selectAllEarlyCheckout.checked = false;
            activeWorkers.forEach(worker => {
                const item = document.createElement('label');
                item.className = 'flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer';
                item.innerHTML = `<input type="checkbox" name="early-checkout-workers" value="${worker.id}" class="h-4 w-4 text-orange-600 rounded"><span class="ml-3 text-gray-700">${worker.name}</span>`;
                earlyCheckoutWorkerList.appendChild(item);
            });
            toggleModal(earlyCheckoutModal, true);
        });
        cancelEarlyCheckoutBtn.addEventListener('click', () => { toggleModal(earlyCheckoutModal, false); earlyCheckoutForm.reset(); });
        selectAllEarlyCheckout.addEventListener('change', (e) => {
            document.querySelectorAll('#early-checkout-worker-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            passwordIcon.className = isPassword ? 'ph ph-eye-slash' : 'ph ph-eye';
        });
        managementBtn.addEventListener('click', () => {
            pendingAction = { type: 'management' };
            passwordTitle.textContent = "Acceso a Gerencia";
            toggleModal(passwordModal, true);
        });
        closeManagementBtn.addEventListener('click', () => toggleModal(managementModal, false));
        
        auth.onAuthStateChanged(user => { if (user) { currentUserId = user.uid; userIdEl.textContent = currentUserId.substring(0, 8); listenToWorkers(); } });
        
        async function authenticateUser() {
            try { await signInAnonymously(auth); } catch (error) {
                console.error("Authentication Error:", error);
                if (error.code === 'auth/configuration-not-found') {
                     showAlert( 'Error de Configuración de Firebase', 'El inicio de sesión anónimo no está habilitado. Ve a tu Consola de Firebase > Authentication > Sign-in method y activa el proveedor "Anónimo".', 'error');
                } else { showAlert('Error de Autenticación', 'No se pudo conectar.', 'error'); }
            }
        }
        
        function listenToWorkers() {
            const workersCollection = collection(db, `artifacts/${appId}/public/data/workers`);
            onSnapshot(workersCollection, (snapshot) => { 
                loadingRow.style.display = 'none'; 
                workersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWorkersTable();
            }, (error) => { console.error(error); showAlert('Error', 'No se pudo obtener la lista.', 'error'); });
        }

        async function renderWorkersTable() {
            const checkedIds = new Set(Array.from(document.querySelectorAll('.worker-checkbox:checked')).map(cb => cb.dataset.id));
            workersTableBody.innerHTML = '';
            if (workersData.length === 0) { workersTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8"><div class="text-gray-500"><i class="ph ph-users text-4xl mb-2"></i><p class="font-semibold">No hay personal.</p></div></td></tr>`; return; }
            const sortedWorkers = [...workersData].sort((a, b) => a.name.localeCompare(b.name));
            for (const [index, worker] of sortedWorkers.entries()) {
                const row = document.createElement('tr');
                const isChecked = checkedIds.has(worker.id) ? 'checked' : '';
                row.dataset.workerId = worker.id;
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="worker-checkbox w-4 h-4 text-blue-600 rounded" data-id="${worker.id}" ${isChecked}></td>
                    <td class="px-4 py-4 font-medium text-gray-900 whitespace-nowrap">${worker.name}<div class="text-xs text-gray-500">${worker.dni || 'N/A'}</div></td>
                    <td class="px-4 py-3">${worker.role}</td>
                    <td class="px-4 py-3 text-center font-mono text-base daily-duration-cell">00:00</td>
                    <td class="px-4 py-3 text-center font-mono text-base total-duration-cell">00:00</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(worker.hourlyRate)}</td>
                    <td class="px-4 py-3 text-right font-bold text-blue-600 pay-cell">${formatCurrency(0)}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <button class="edit-worker-btn text-blue-500 hover:text-blue-700" data-id="${worker.id}" title="Editar Obrero"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button class="delete-worker-btn text-red-500 hover:text-red-700" data-id="${worker.id}" title="Eliminar Obrero"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </td>`;
                workersTableBody.appendChild(row);
                await updateWorkerRow(worker.id);
            }
        }
        
        async function updateWorkerRow(workerId) {
            const worker = workersData.find(w => w.id === workerId);
            const row = workersTableBody.querySelector(`tr[data-worker-id="${workerId}"]`);
            if (!worker || !row) return;

            const now = new Date();
            const todayStr = dateToYYYYMMDD(now);
            let totalWorkDuration = worker.totalWorkSeconds || 0;
            
            const dailyRecord = await getOrCreateDailyRecord(workerId, todayStr);
            let dailyWorkSeconds = dailyRecord.workSeconds || 0;
            
            if (worker.checkedIn && worker.lastCheckInTime) {
                const sessionSeconds = (now.getTime() - worker.lastCheckInTime.toDate().getTime()) / 1000;
                totalWorkDuration += sessionSeconds;
                dailyWorkSeconds += sessionSeconds;
                row.className = 'bg-green-100 border-b status-pulse';
            } else {
                row.className = workersData.findIndex((w, i) => w.id === workerId) % 2 === 0 ? 'bg-white border-b' : 'bg-gray-50 border-b';
            }
            
            const totalPay = (totalWorkDuration / 3600) * (worker.hourlyRate || 0);
            
            row.querySelector('.daily-duration-cell').textContent = formatTime(dailyWorkSeconds);
            row.querySelector('.total-duration-cell').textContent = formatTime(totalWorkDuration);
            row.querySelector('.pay-cell').textContent = formatCurrency(totalPay);

            updateGrandTotal();
            updateCheckInButtonState();
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            const now = new Date();
            workersData.forEach(worker => {
                let totalWorkDuration = worker.totalWorkSeconds || 0;
                if (worker.checkedIn && worker.lastCheckInTime) {
                    const sessionSeconds = (now.getTime() - worker.lastCheckInTime.toDate().getTime()) / 1000;
                    totalWorkDuration += sessionSeconds;
                }
                grandTotal += (totalWorkDuration / 3600) * (worker.hourlyRate || 0);
            });
            grandTotalDisplay.textContent = formatCurrency(grandTotal);
        }
        
        function updateCheckInButtonState() {
            const selectedWorkers = Array.from(document.querySelectorAll('.worker-checkbox:checked'));
            const allCheckedIn = selectedWorkers.every(cb => {
                const worker = workersData.find(w => w.id === cb.dataset.id);
                return worker && worker.checkedIn;
            });
            checkInBtn.disabled = selectedWorkers.length === 0;
            checkInBtn.textContent = selectedWorkers.length === 0 ? 'Marcar Ingreso' : (allCheckedIn ? 'Marcar Salida' : 'Marcar Ingreso');
            checkInBtn.querySelector('i').className = allCheckedIn ? 'ph ph-timer-pause' : 'ph ph-timer';
            checkInBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-red-500', 'hover:bg-red-600');
            checkInBtn.classList.add(allCheckedIn ? 'bg-red-500' : 'bg-green-500', allCheckedIn ? 'hover:bg-red-600' : 'hover:bg-green-600');
        }
        
        workersTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('worker-checkbox')) {
                const allSelected = workersData.every(w => {
                    const checkbox = workersTableBody.querySelector(`input[data-id="${w.id}"]`);
                    return checkbox ? checkbox.checked : false;
                });
                selectAllCheckbox.checked = allSelected;
                updateCheckInButtonState();
            }
        });
        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.worker-checkbox').forEach(cb => cb.checked = e.target.checked);
            updateCheckInButtonState();
        });
        
        async function getOrCreateDailyRecord(workerId, dateStr) {
            const docRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${workerId}`);
            if (dailyRecordsCache[workerId] && dailyRecordsCache[workerId][dateStr]) {
                return dailyRecordsCache[workerId][dateStr];
            }
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : {};
            if (!dailyRecordsCache[workerId]) dailyRecordsCache[workerId] = {};
            dailyRecordsCache[workerId][dateStr] = data[dateStr] || {};
            return dailyRecordsCache[workerId][dateStr];
        }

        async function updateDailyRecord(workerId, dateStr, updateData) {
            const docRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${workerId}`);
            const fieldPath = `${dateStr}`;
            if (!dailyRecordsCache[workerId]) dailyRecordsCache[workerId] = {};
            if (!dailyRecordsCache[workerId][dateStr]) dailyRecordsCache[workerId][dateStr] = {};
            Object.assign(dailyRecordsCache[workerId][dateStr], updateData);
            return updateDoc(docRef, { [fieldPath]: dailyRecordsCache[workerId][dateStr] }, { merge: true });
        }

        checkInBtn.addEventListener('click', () => {
            const selectedWorkers = Array.from(document.querySelectorAll('.worker-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedWorkers.length === 0) return showAlert('Atención', 'Selecciona al menos un obrero.', 'info');
            const allCheckedIn = selectedWorkers.every(id => workersData.find(w => w.id === id)?.checkedIn);
            if (allCheckedIn) {
                checkOutWorkers(selectedWorkers);
            } else {
                checkInWorkers(selectedWorkers);
            }
        });
        
        async function checkInWorkers(workerIds) {
            const batch = writeBatch(db);
            const workersCollection = collection(db, `artifacts/${appId}/public/data/workers`);
            const now = serverTimestamp();
            for (const id of workerIds) {
                const workerRef = doc(workersCollection, id);
                batch.update(workerRef, { checkedIn: true, lastCheckInTime: now, checkInHistory: arrayUnion(now) });
            }
            try {
                await batch.commit();
                showAlert('Éxito', 'Obreros marcados como ingresados.', 'success');
            } catch (e) {
                showAlert('Error', 'No se pudo marcar la entrada.', 'error');
            }
        }

        async function checkOutWorkers(workerIds) {
            const workersCollection = collection(db, `artifacts/${appId}/public/data/workers`);
            try {
                await runTransaction(db, async (transaction) => {
                    for (const id of workerIds) {
                        const workerRef = doc(workersCollection, id);
                        const workerDoc = await transaction.get(workerRef);
                        if (!workerDoc.exists() || !workerDoc.data().checkedIn) continue;
                        
                        const data = workerDoc.data();
                        const lastCheckInTime = data.lastCheckInTime.toDate();
                        const now = new Date();
                        const sessionDuration = (now.getTime() - lastCheckInTime.getTime()) / 1000;
                        
                        const todayStr = dateToYYYYMMDD(now);
                        const dailyRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${id}`);
                        const dailyDoc = await transaction.get(dailyRef);
                        
                        let dailyWorkSeconds = dailyDoc.exists() && dailyDoc.data()[todayStr] ? dailyDoc.data()[todayStr].workSeconds || 0 : 0;
                        dailyWorkSeconds += sessionDuration;
                        const totalWorkSeconds = (data.totalWorkSeconds || 0) + sessionDuration;
                        
                        transaction.update(workerRef, {
                            checkedIn: false,
                            lastCheckOutTime: now,
                            totalWorkSeconds: totalWorkSeconds,
                            checkOutHistory: arrayUnion(now)
                        });
                        
                        const dailyData = {
                            workSeconds: dailyWorkSeconds,
                            latenessMinutes: data.latenessMinutes || 0,
                            checkoutReason: '',
                        };
                        
                        transaction.set(dailyRef, { [todayStr]: dailyData }, { merge: true });
                    }
                });
                showAlert('Éxito', 'Obreros marcados como salidos.', 'success');
            } catch (e) {
                console.error("Transaction failed: ", e);
                showAlert('Error', 'No se pudo marcar la salida.', 'error');
            }
        }

        addWorkerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(addWorkerForm);
            const workerData = Object.fromEntries(formData.entries());
            workerData.hourlyRate = parseFloat(workerData.hourlyRate);
            workerData.totalWorkSeconds = 0;
            workerData.checkedIn = false;
            try {
                const workersCollection = collection(db, `artifacts/${appId}/public/data/workers`);
                await setDoc(doc(workersCollection, workerData.dni), workerData);
                showAlert('Éxito', `${workerData.name} ha sido agregado.`, 'success');
                toggleModal(addWorkerModal, false);
                addWorkerForm.reset();
            } catch (e) {
                showAlert('Error', 'No se pudo agregar al personal.', 'error');
            }
        });
        
        editWorkerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const workerId = el('edit-worker-id').value;
            const formData = new FormData(editWorkerForm);
            const workerData = Object.fromEntries(formData.entries());
            workerData.hourlyRate = parseFloat(workerData.hourlyRate);
            try {
                const workerRef = doc(db, `artifacts/${appId}/public/data/workers/${workerId}`);
                await updateDoc(workerRef, workerData);
                showAlert('Éxito', `${workerData.name} ha sido actualizado.`, 'success');
                toggleModal(editWorkerModal, false);
                editWorkerForm.reset();
            } catch (e) {
                showAlert('Error', 'No se pudo actualizar al personal.', 'error');
            }
        });
        
        workersTableBody.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-worker-btn');
            const deleteBtn = e.target.closest('.delete-worker-btn');
            
            if (editBtn) {
                const workerId = editBtn.dataset.id;
                const worker = workersData.find(w => w.id === workerId);
                if (worker) {
                    el('edit-worker-id').value = worker.id;
                    el('edit-name').value = worker.name;
                    el('edit-role').value = worker.role;
                    el('edit-dni').value = worker.dni || '';
                    el('edit-hourlyRate').value = worker.hourlyRate;
                    el('edit-email').value = worker.email || '';
                    toggleModal(editWorkerModal, true);
                }
            } else if (deleteBtn) {
                pendingAction = { type: 'delete', workerId: deleteBtn.dataset.id };
                passwordTitle.textContent = "Eliminar Personal";
                toggleModal(passwordModal, true);
            }
        });
        
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            if (password === '123') { // Simple password check
                toggleModal(passwordModal, false);
                passwordForm.reset();
                executePendingAction();
            } else {
                showAlert('Error', 'Contraseña incorrecta.', 'error');
            }
        });
        
        async function executePendingAction() {
            if (pendingAction.type === 'delete' && pendingAction.workerId) {
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/workers/${pendingAction.workerId}`);
                    await deleteDoc(docRef);
                    showAlert('Éxito', 'Personal eliminado.', 'success');
                } catch (e) {
                    showAlert('Error', 'No se pudo eliminar al personal.', 'error');
                }
            } else if (pendingAction.type === 'management') {
                await renderManagementList();
                toggleModal(managementModal, true);
            }
            pendingAction = { type: null, workerId: null };
        }
        
        async function renderManagementList() {
            managementWorkerList.innerHTML = '';
            const sortedWorkers = [...workersData].sort((a, b) => a.name.localeCompare(b.name));
            sortedWorkers.forEach(worker => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 border-b border-gray-200';
                item.innerHTML = `
                    <label class="flex items-center space-x-3 text-sm font-medium text-gray-700">
                        <input type="checkbox" name="management-worker" value="${worker.id}" class="h-4 w-4 text-red-600 rounded">
                        <span>${worker.name}</span>
                    </label>
                    <span class="text-xs text-gray-500">${worker.id}</span>
                `;
                managementWorkerList.appendChild(item);
            });
            adjustSelectedBtn.disabled = true;
        }
        managementWorkerList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const anyChecked = managementWorkerList.querySelector('input[type="checkbox"]:checked');
                adjustSelectedBtn.disabled = !anyChecked;
            }
        });
        adjustSelectedBtn.addEventListener('click', async () => {
            const selectedCheckbox = managementWorkerList.querySelector('input[type="checkbox"]:checked');
            if (selectedCheckbox) {
                const workerId = selectedCheckbox.value;
                pendingAction = { type: 'adjustment', workerId: workerId };
                const worker = workersData.find(w => w.id === workerId);
                if (!worker) return;
                el('adjust-detail-worker-id').value = worker.id;
                el('adjust-detail-worker-name').textContent = `Ajustando registro de: ${worker.name}`;
                await renderAdjustmentDateSelector(workerId);
                toggleModal(managementModal, false);
                toggleModal(adjustmentDetailModal, true);
            }
        });

        async function renderAdjustmentDateSelector(workerId) {
            adjustmentDateSelector.innerHTML = '';
            const dailyRecordsRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${workerId}`);
            const docSnap = await getDoc(dailyRecordsRef);
            if (docSnap.exists()) {
                const records = docSnap.data();
                const sortedDates = Object.keys(records).sort((a, b) => b.localeCompare(a));
                sortedDates.forEach(dateStr => {
                    const option = document.createElement('option');
                    option.value = dateStr;
                    option.textContent = dateStr;
                    adjustmentDateSelector.appendChild(option);
                });
                const todayStr = dateToYYYYMMDD(new Date());
                if (!records[todayStr]) {
                    const option = document.createElement('option');
                    option.value = todayStr;
                    option.textContent = todayStr;
                    adjustmentDateSelector.prepend(option);
                }
                
                const selectedDate = sortedDates.length > 0 ? sortedDates[0] : todayStr;
                if(records[selectedDate]){
                    const record = records[selectedDate];
                    el('adjust-hours-day').value = formatTime(record.workSeconds);
                    el('adjust-lateness').value = record.latenessMinutes || 0;
                }
            } else {
                showAlert('Información', 'No hay registros diarios para este obrero.', 'info');
                toggleModal(adjustmentDetailModal, false);
                return;
            }
        }

        adjustmentDateSelector.addEventListener('change', async (e) => {
            const workerId = el('adjust-detail-worker-id').value;
            const dateStr = e.target.value;
            const dailyRecordsRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${workerId}`);
            const docSnap = await getDoc(dailyRecordsRef);
            if (docSnap.exists() && docSnap.data()[dateStr]) {
                const record = docSnap.data()[dateStr];
                el('adjust-hours-day').value = formatTime(record.workSeconds);
                el('adjust-lateness').value = record.latenessMinutes || 0;
            } else {
                el('adjust-hours-day').value = '00:00';
                el('adjust-lateness').value = 0;
            }
        });

        adjustmentDetailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const workerId = el('adjust-detail-worker-id').value;
            const dateStr = adjustmentDateSelector.value;
            const hoursDayInput = el('adjust-hours-day').value;
            const latenessMinutes = parseInt(el('adjust-lateness').value) || 0;
            const [hours, minutes] = hoursDayInput.split(':').map(Number);
            const workSeconds = (hours * 3600) + (minutes * 60);

            try {
                const dailyRecordsRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${workerId}`);
                await updateDoc(dailyRecordsRef, {
                    [dateStr]: {
                        workSeconds: workSeconds,
                        latenessMinutes: latenessMinutes
                    }
                }, { merge: true });
                showAlert('Éxito', 'Ajuste guardado.', 'success');
                toggleModal(adjustmentDetailModal, false);
            } catch (e) {
                console.error("Error updating document: ", e);
                showAlert('Error', 'No se pudo guardar el ajuste.', 'error');
            }
        });
        
        earlyCheckoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedWorkers = Array.from(document.querySelectorAll('#early-checkout-worker-list input[type="checkbox"]:checked')).map(cb => cb.value);
            if (selectedWorkers.length === 0) return showAlert('Atención', 'Selecciona al menos un obrero.', 'info');
            const reason = el('checkout-reason').value;
            const batch = writeBatch(db);
            const workersCollection = collection(db, `artifacts/${appId}/public/data/workers`);
            const now = serverTimestamp();
            const todayStr = dateToYYYYMMDD(new Date());

            for (const id of selectedWorkers) {
                const workerRef = doc(workersCollection, id);
                const dailyRecordsRef = doc(db, `artifacts/${appId}/public/data/dailyRecords/${id}`);

                const worker = workersData.find(w => w.id === id);
                const sessionDuration = worker && worker.checkedIn && worker.lastCheckInTime ? (new Date().getTime() - worker.lastCheckInTime.toDate().getTime()) / 1000 : 0;
                const totalWorkSeconds = (worker.totalWorkSeconds || 0) + sessionDuration;
                
                const dailyRecord = (await getDoc(dailyRecordsRef)).data()?.[todayStr] || {};
                const dailyWorkSeconds = (dailyRecord.workSeconds || 0) + sessionDuration;

                batch.update(workerRef, {
                    checkedIn: false,
                    lastCheckOutTime: now,
                    totalWorkSeconds: totalWorkSeconds,
                    checkOutHistory: arrayUnion(now)
                });
                
                batch.set(dailyRecordsRef, { 
                    [todayStr]: {
                        ...dailyRecord,
                        workSeconds: dailyWorkSeconds,
                        checkoutReason: reason
                    }
                }, { merge: true });
            }

            try {
                await batch.commit();
                showAlert('Éxito', 'Salida anticipada registrada.', 'success');
                toggleModal(earlyCheckoutModal, false);
                earlyCheckoutForm.reset();
            } catch (e) {
                console.error("Transaction failed: ", e);
                showAlert('Error', 'No se pudo registrar la salida anticipada.', 'error');
            }
        });

        async function generateReport() {
            const dailyRecordsCollection = collection(db, `artifacts/${appId}/public/data/dailyRecords`);
            try {
                const querySnapshot = await getDocs(dailyRecordsCollection);
                const allRecords = {};
                querySnapshot.forEach(doc => {
                    allRecords[doc.id] = doc.data();
                });
                
                const report = [];
                let grandTotalCost = 0;
                let uniqueDates = new Set();

                workersData.forEach(worker => {
                    const workerRecords = allRecords[worker.id] || {};
                    const sortedDates = Object.keys(workerRecords).sort();
                    sortedDates.forEach(date => uniqueDates.add(date));

                    const totalWorkerHours = (worker.totalWorkSeconds || 0) / 3600;
                    const totalWorkerCost = totalWorkerHours * (worker.hourlyRate || 0);
                    grandTotalCost += totalWorkerCost;

                    const dailyEntries = sortedDates.map(date => {
                        const daily = workerRecords[date] || {};
                        const dailyHours = (daily.workSeconds || 0) / 3600;
                        return {
                            date,
                            hours: dailyHours.toFixed(2),
                            cost: (dailyHours * (worker.hourlyRate || 0)).toFixed(2),
                            lateness: daily.latenessMinutes || 0,
                            reason: daily.checkoutReason || ''
                        };
                    });

                    report.push({
                        name: worker.name,
                        role: worker.role,
                        hourlyRate: worker.hourlyRate,
                        totalHours: totalWorkerHours.toFixed(2),
                        totalCost: totalWorkerCost.toFixed(2),
                        daily: dailyEntries
                    });
                });

                const sortedDatesArray = Array.from(uniqueDates).sort();
                const startDate = sortedDatesArray.length > 0 ? sortedDatesArray[0] : '';
                const endDate = sortedDatesArray.length > 0 ? sortedDatesArray[sortedDatesArray.length - 1] : '';

                currentReportData = {
                    range: startDate && endDate ? `${startDate} - ${endDate}` : 'Sin datos',
                    data: report
                };
                
                renderReport(currentReportData, grandTotalCost);
            } catch (e) {
                console.error("Error generating report: ", e);
                showAlert('Error', 'No se pudo generar el reporte.', 'error');
            }
            toggleModal(reportModal, true);
        }

        function renderReport(report, grandTotalCost) {
            reportDateRange.textContent = report.range;
            reportBody.innerHTML = '';
            if (report.data.length === 0) {
                reportBody.innerHTML = `<div class="text-center p-12 text-gray-500"><i class="ph ph-note-blank text-4xl mb-2"></i><p class="font-semibold">No hay datos para generar el reporte.</p></div>`;
                return;
            }
            
            const grandTotalEl = document.createElement('div');
            grandTotalEl.className = 'bg-blue-50 p-4 rounded-lg text-center mb-6 no-print';
            grandTotalEl.innerHTML = `<p class="text-blue-800 font-semibold">Costo Total Estimado del Reporte:</p><p class="text-3xl font-bold text-blue-700 mt-1">${formatCurrency(grandTotalCost)}</p>`;
            reportBody.appendChild(grandTotalEl);
            
            report.data.forEach(worker => {
                const workerCard = document.createElement('div');
                workerCard.className = 'bg-gray-100 p-4 rounded-lg shadow-sm mb-6';
                workerCard.innerHTML = `<h3 class="text-lg font-bold">${worker.name} (${worker.role})</h3><p class="text-sm text-gray-600 mb-2">Precio por Hora: ${formatCurrency(worker.hourlyRate)}</p><p class="font-bold text-gray-800">Horas Totales: ${worker.totalHours} hrs - Costo Total: ${formatCurrency(worker.totalCost)}</p><table class="min-w-full text-xs mt-4"><thead class="bg-gray-200"><tr class="font-bold"><th class="px-2 py-1">Fecha</th><th class="px-2 py-1">Horas</th><th class="px-2 py-1">Costo Diario</th><th class="px-2 py-1">Retraso (min)</th><th class="px-2 py-1">Motivo Salida</th></tr></thead><tbody class="bg-white" id="report-worker-table-${worker.name.replace(/\s/g, '-')}-${worker.role.replace(/\s/g, '-')}" style="white-space: nowrap;"></tbody></table>`;
                reportBody.appendChild(workerCard);

                const workerTableBody = document.getElementById(`report-worker-table-${worker.name.replace(/\s/g, '-')}-${worker.role.replace(/\s/g, '-')}`);
                worker.daily.forEach(day => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="border px-2 py-1">${day.date}</td><td class="border px-2 py-1">${day.hours}</td><td class="border px-2 py-1">${formatCurrency(day.cost)}</td><td class="border px-2 py-1">${day.lateness}</td><td class="border px-2 py-1 max-w-xs overflow-hidden text-ellipsis">${day.reason || 'N/A'}</td>`;
                    workerTableBody.appendChild(row);
                });
            });
        }

        function generateAndDownloadCSV() {
            if (currentReportData.data.length === 0) {
                return showAlert('Error', 'No hay datos para exportar a CSV.', 'error');
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            const uniqueDates = new Set();
            currentReportData.data.forEach(worker => {
                worker.daily.forEach(day => uniqueDates.add(day.date));
            });
            const sortedDates = Array.from(uniqueDates).sort();

            const header = ["Obrero", "Categoría", "Precio/Hora", "Horas Totales", "Costo Total", ...sortedDates.map(d => `Horas ${d}`), ...sortedDates.map(d => `Retraso ${d}`), ...sortedDates.map(d => `Motivo ${d}`)];
            csvContent += header.join(";") + "\r\n";
            
            currentReportData.data.forEach(worker => {
                const workerData = { ...worker };
                const dailyDataMap = new Map(worker.daily.map(d => [d.date, d]));
                const row = [
                    worker.name,
                    worker.role,
                    worker.hourlyRate.toFixed(2),
                    worker.totalHours,
                    worker.totalCost,
                    ...sortedDates.map(date => dailyDataMap.get(date)?.hours || "0.00"),
                    ...sortedDates.map(date => dailyDataMap.get(date)?.lateness || "0"),
                    ...sortedDates.map(date => dailyDataMap.get(date)?.reason || "N/A"),
                ];
                csvContent += row.join(";") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `reporte_obra_${currentReportData.range}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('Éxito', 'El reporte ha sido descargado.', 'success');
        }

        window.addEventListener('load', () => {
            authenticateUser();
            updateClock();
            setInterval(updateClock, 1000);
            setInterval(updateGrandTotal, 1000);
            
            // Agrega este código para registrar el Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.error('Fallo el registro del Service Worker:', error);
                    });
            }
        });

    </script>

</body>
</html>
