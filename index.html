<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Control Horario - Obra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-visible { opacity: 1; pointer-events: auto; }
        .modal-content-hidden { transform: translateY(-50px) scale(0.95); }
        .modal-content-visible { transform: translateY(0) scale(1); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .tab-active { border-color: #4f46e5; color: #4f46e5; }
        /* Estilos para impresión del reporte */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; margin: 0; padding: 0; }
            #report-body { padding: 0 !important; }
            .modal-content { max-width: none; width: 100%; box-shadow: none; border: none; transform: none !important; }
            #report-modal { position: static; display: block; opacity: 1; background: none; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-full mx-auto">
        <header class="mb-8 p-4 bg-white rounded-lg shadow-md no-print">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Planilla de Control Horario</h1>
                    <p id="current-date" class="text-gray-500 text-sm md:text-base">Cargando...</p>
                </div>
                <div class="text-center md:text-right mt-4 md:mt-0">
                    <p class="text-xs text-gray-400">ID de Sesión:</p>
                    <p id="user-id" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">Cargando...</p>
                </div>
            </div>
        </header>

        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 no-print">
            <button id="check-in-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-timer"></i><span>Marcar Ingreso</span></button>
            <button id="early-checkout-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-user-minus"></i><span>Salida Anticipada</span></button>
            <button id="add-worker-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-user-plus"></i><span>Agregar Personal</span></button>
            <button id="create-report-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-file-text"></i><span>Crear Reporte</span></button>
            <button id="management-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105 flex items-center justify-center space-x-2"><i class="ph ph-shield-warning"></i><span>Gerencia</span></button>
        </div>

        <div class="mb-6 p-4 bg-white rounded-lg shadow-md no-print">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Resumen General</h2>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Costo Total Estimado Acumulado:</span>
                <span id="grand-total-display" class="text-2xl font-bold text-green-600">$0.00</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100 no-print">
                    <tr>
                        <th scope="col" class="p-4"><input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"></th>
                        <th scope="col" class="px-4 py-3">Obrero</th>
                        <th scope="col" class="px-4 py-3">Categoría</th>
                        <th scope="col" class="px-4 py-3 text-center">Horas del Día</th>
                        <th scope="col" class="px-4 py-3 text-center">Horas Totales</th>
                        <th scope="col" class="px-4 py-3 text-right">Precio / Hr</th>
                        <th scope="col" class="px-4 py-3 text-right">Total Acumulado</th>
                        <th scope="col" class="px-4 py-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="workers-table-body">
                     <tr id="loading-row"><td colspan="8" class="text-center p-8"><div class="flex justify-center items-center space-x-2 text-gray-500"><i class="ph ph-circle-notch text-2xl animate-spin"></i><span>Cargando datos...</span></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="add-worker-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content modal-content-hidden">
            <form id="add-worker-form" class="p-6"><h2 class="text-2xl font-bold mb-6">Agregar Personal</h2><div class="mb-4"><label for="name" class="block text-sm font-bold mb-2">Nombre Completo:</label><input type="text" id="name" name="name" class="shadow border rounded w-full py-2 px-3" required></div><div class="mb-4"><label for="role" class="block text-sm font-bold mb-2">Cargo:</label><select id="role" name="role" class="shadow border rounded w-full py-2 px-3" required><option value="Ayudante">Ayudante</option><option value="Medio Oficial">Medio Oficial</option><option value="Oficial">Oficial</option><option value="Oficial Especializado">Oficial Especializado</option></select></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="dni" class="block text-sm font-bold mb-2">DNI/CUIL:</label><input type="text" id="dni" name="dni" class="shadow border rounded w-full py-2 px-3"></div><div><label for="hourlyRate" class="block text-sm font-bold mb-2">Precio por Hora ($):</label><input type="number" id="hourlyRate" name="hourlyRate" step="0.01" class="shadow border rounded w-full py-2 px-3" required></div></div><div class="mb-6"><label for="email" class="block text-sm font-bold mb-2">Correo:</label><input type="email" id="email" name="email" class="shadow border rounded w-full py-2 px-3"></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-add-worker" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar</button></div></form>
        </div>
    </div>
    <div id="edit-worker-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content modal-content-hidden">
            <form id="edit-worker-form" class="p-6"><h2 class="text-2xl font-bold mb-6">Editar Personal</h2><input type="hidden" id="edit-worker-id"><div class="mb-4"><label for="edit-name" class="block text-sm font-bold mb-2">Nombre Completo:</label><input type="text" id="edit-name" name="name" class="shadow border rounded w-full py-2 px-3" required></div><div class="mb-4"><label for="edit-role" class="block text-sm font-bold mb-2">Cargo:</label><select id="edit-role" name="role" class="shadow border rounded w-full py-2 px-3" required><option value="Ayudante">Ayudante</option><option value="Medio Oficial">Medio Oficial</option><option value="Oficial">Oficial</option><option value="Oficial Especializado">Oficial Especializado</option></select></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="edit-dni" class="block text-sm font-bold mb-2">DNI/CUIL:</label><input type="text" id="edit-dni" name="dni" class="shadow border rounded w-full py-2 px-3"></div><div><label for="edit-hourlyRate" class="block text-sm font-bold mb-2">Precio por Hora ($):</label><input type="number" id="edit-hourlyRate" name="hourlyRate" step="0.01" class="shadow border rounded w-full py-2 px-3" required></div></div><div class="mb-6"><label for="edit-email" class="block text-sm font-bold mb-2">Correo:</label><input type="email" id="edit-email" name="email" class="shadow border rounded w-full py-2 px-3"></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-edit-worker" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button></div></form>
        </div>
    </div>
    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content modal-content-hidden">
            <form id="password-form" class="p-6"><h2 id="password-title" class="text-2xl font-bold mb-4">Acción Protegida</h2><p class="text-sm text-gray-600 mb-6">Por favor, introduce la contraseña para continuar.</p>
            <div>
                <label for="password" class="block text-sm font-bold mb-2">Contraseña:</label>
                <div class="relative">
                    <input type="password" id="password" name="password" class="shadow border rounded w-full py-2 px-3 pr-10" required>
                    <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                        <i id="password-icon" class="ph ph-eye"></i>
                    </button>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancel-password" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></form>
        </div>
    </div>
    <div id="management-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content modal-content-hidden flex flex-col" style="height: 90vh;">
            <div class="p-4 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Panel de Gerencia</h2>
                    <p class="text-sm text-gray-600">Ajuste manual de registros.</p>
                </div>
                <button id="adjust-selected-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2" disabled>
                    <i class="ph ph-wrench"></i>
                    <span>Ajustar Seleccionado</span>
                </button>
            </div>
            <div id="management-worker-list" class="p-6 overflow-y-auto flex-grow">
            </div>
             <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="button" id="close-management-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>
     <div id="adjustment-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content modal-content-hidden">
            <form id="adjustment-detail-form" class="p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">Ajuste Detallado de Registro</h2>
                        <p id="adjust-detail-worker-name" class="text-gray-600 mb-4"></p>
                    </div>
                    <div class="w-48">
                         <label for="adjustment-date-selector" class="block text-sm font-bold mb-2">Seleccionar Fecha:</label>
                         <select id="adjustment-date-selector" class="shadow border rounded w-full py-2 px-3"></select>
                    </div>
                </div>
                <input type="hidden" id="adjust-detail-worker-id">
                <div class="mt-6 p-4 border rounded-lg">
                    <h3 class="font-bold mb-3">Ajustes Generales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="adjust-hours-day" class="block text-sm font-bold mb-2">Horas del Día (HH:MM)</label>
                            <input type="text" id="adjust-hours-day" placeholder="Ej: 08:30" class="shadow border rounded w-full py-2 px-3">
                        </div>
                        <div>
                            <label for="adjust-lateness" class="block text-sm font-bold mb-2">Total Minutos de Retraso</label>
                            <input type="number" id="adjust-lateness" class="shadow border rounded w-full py-2 px-3">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancel-adjustment-detail" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg">Aplicar Ajustes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="early-checkout-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content modal-content-hidden">
            <form id="early-checkout-form" class="p-6">
                <h2 class="text-2xl font-bold mb-4">Salida Anticipada</h2>
                <p class="text-sm text-gray-600 mb-6">Selecciona el personal y especifica el motivo.</p>
                <div class="flex justify-between items-center p-2 border-b mb-2">
                    <label for="select-all-early-checkout" class="flex items-center space-x-2 text-sm font-semibold">
                        <input type="checkbox" id="select-all-early-checkout" class="h-4 w-4 text-orange-600 rounded">
                        <span>Seleccionar Todos</span>
                    </label>
                </div>
                <div id="early-checkout-worker-list" class="mb-4 max-h-60 overflow-y-auto rounded-lg p-1 space-y-2"></div>
                <div class="mb-6"><label for="checkout-reason" class="block text-sm font-bold mb-2">Motivo:</label><textarea id="checkout-reason" name="checkout-reason" rows="3" class="shadow border rounded w-full py-2 px-3" required></textarea></div>
                <div class="flex justify-end space-x-4"><button type="button" id="cancel-early-checkout" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div>
            </form>
        </div>
    </div>
    <div id="report-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl modal-content modal-content-hidden flex flex-col" style="height: 90vh;">
            <div class="p-6 border-b flex justify-between items-center no-print">
                 <div>
                    <h2 class="text-3xl font-bold">Reporte General</h2>
                    <p id="report-date-range" class="text-gray-500"></p>
                </div>
                <button type="button" id="close-report-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
            <div id="report-body" class="p-6 md:p-8 overflow-y-auto flex-grow">
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-4 no-print">
                 <button type="button" id="download-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2"><i class="ph ph-file-csv"></i><span>Descargar CSV</span></button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-backdrop bg-black bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content"><div class="p-6 text-center"><div id="alert-icon" class="mx-auto mb-4"></div><h3 id="alert-title" class="text-lg font-medium mb-2"></h3><p id="alert-message" class="text-sm text-gray-500"></p><div class="mt-6"><button id="alert-ok-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Entendido</button></div></div></div>
    </div>

    <script type="module">
        // La importación de módulos de Firebase es correcta y funciona.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDocs, onSnapshot, updateDoc, deleteDoc, serverTimestamp, Timestamp, writeBatch, arrayUnion, runTransaction, setDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (Copiada de tu imagen y código original)
        const firebaseConfig = {
          apiKey: "AIzaSyBmqG6_pD7OzSGhOaZSRc4IVfXwNaADE8U",
          authDomain: "planilla-c17ab.firebaseapp.com",
          projectId: "planilla-c17ab",
          storageBucket: "planilla-c17ab.appspot.com",
          messagingSenderId: "993902505533",
          appId: "1:993902505533:web:9154f4bd2c95e088c78454"
        };
        
        // Resto de la lógica de tu aplicación (no se hicieron cambios aquí ya que todo es correcto)
        const appId = 'planilla-c17ab';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserId = null;
        let workersData = [];
        let dailyProcessFlags = { morning: false, evening: false };
        let pendingAction = { type: null, workerId: null };
        let currentReportData = { range: null, data: [] };
        let dailyRecordsCache = {};

        const el = (id) => document.getElementById(id);
        const workersTableBody = el('workers-table-body');
        const loadingRow = el('loading-row');
        const selectAllCheckbox = el('select-all-checkbox');
        const addWorkerBtn = el('add-worker-btn');
        const checkInBtn = el('check-in-btn');
        const earlyCheckoutBtn = el('early-checkout-btn');
        const createReportBtn = el('create-report-btn');
        const managementBtn = el('management-btn');
        const currentDateEl = el('current-date');
        const userIdEl = el('user-id');
        const grandTotalDisplay = el('grand-total-display');
        const addWorkerModal = el('add-worker-modal');
        const cancelAddWorkerBtn = el('cancel-add-worker');
        const addWorkerForm = el('add-worker-form');
        const editWorkerModal = el('edit-worker-modal');
        const cancelEditWorkerBtn = el('cancel-edit-worker');
        const editWorkerForm = el('edit-worker-form');
        const passwordModal = el('password-modal');
        const passwordTitle = el('password-title');
        const cancelPasswordBtn = el('cancel-password');
        const passwordForm = el('password-form');
        const togglePasswordBtn = el('toggle-password-btn');
        const passwordInput = el('password');
        const passwordIcon = el('password-icon');
        const earlyCheckoutModal = el('early-checkout-modal');
        const cancelEarlyCheckoutBtn = el('cancel-early-checkout');
        const earlyCheckoutForm = el('early-checkout-form');
        const earlyCheckoutWorkerList = el('early-checkout-worker-list');
        const selectAllEarlyCheckout = el('select-all-early-checkout');
        const managementModal = el('management-modal');
        const closeManagementBtn = el('close-management-btn');
        const managementWorkerList = el('management-worker-list');
        const adjustSelectedBtn = el('adjust-selected-btn');
        const adjustmentDetailModal = el('adjustment-detail-modal');
        const cancelAdjustmentDetailBtn = el('cancel-adjustment-detail');
        const adjustmentDetailForm = el('adjustment-detail-form');
        const adjustmentDateSelector = el('adjustment-date-selector');
        const reportModal = el('report-modal');
        const downloadCsvBtn = el('download-csv-btn');
        const alertModal = el('alert-modal');
        const alertOkBtn = el('alert-ok-btn');
        const alertTitle = el('alert-title');
        const alertMessage = el('alert-message');
        const alertIcon = el('alert-icon');
        const closeReportBtn = el('close-report-btn');
        const reportDateRange = el('report-date-range');
        const reportBody = el('report-body');
        
        function showAlert(title, message, type = 'info') {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            const icons = { success: '<i class="ph ph-check-circle text-4xl text-green-500"></i>', error: '<i class="ph ph-x-circle text-4xl text-red-500"></i>', info: '<i class="ph ph-info text-4xl text-blue-500"></i>' };
            alertIcon.innerHTML = icons[type] || icons['info'];
            toggleModal(alertModal, true);
        }
        alertOkBtn.addEventListener('click', () => toggleModal(alertModal, false));

        function formatTime(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00";
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount || 0);
        }
        function dateToYYYYMMDD(date) {
            return date.toISOString().split('T')[0];
        }

        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            currentDateEl.textContent = now.toLocaleDateString('es-ES', options);
        }

        function toggleModal(modal, visible) {
            const content = modal.querySelector('.modal-content');
            if (visible) {
                modal.classList.add('modal-visible');
                modal.classList.remove('modal-hidden');
                content.classList.add('modal-content-visible');
                content.classList.remove('modal-content-hidden');
            } else {
                modal.classList.add('modal-hidden');
                modal.classList.remove('modal-visible');
                content.classList.add('modal-content-hidden');
                content.classList.remove('modal-content-visible');
            }
        }
        
        addWorkerBtn.addEventListener('click', () => toggleModal(addWorkerModal, true));
        cancelAddWorkerBtn.addEventListener('click', () => { toggleModal(addWorkerModal, false); addWorkerForm.reset(); });
        cancelEditWorkerBtn.addEventListener('click', () => { toggleModal(editWorkerModal, false); editWorkerForm.reset(); });
        cancelPasswordBtn.addEventListener('click', () => { toggleModal(passwordModal, false); passwordForm.reset(); });
        cancelAdjustmentDetailBtn.addEventListener('click', () => { toggleModal(adjustmentDetailModal, false); });
        createReportBtn.addEventListener('click', () => generateReport());
        downloadCsvBtn.addEventListener('click', () => generateAndDownloadCSV());
        closeReportBtn.addEventListener('click', () => toggleModal(reportModal, false));
        
        earlyCheckoutBtn.addEventListener('click', () => {
            const activeWorkers = workersData.filter(w => w.checkedIn);
            if (activeWorkers.length === 0) return showAlert('Información', 'No hay ningún obrero en turno.', 'info');
            earlyCheckoutWorkerList.innerHTML = '';
            selectAllEarlyCheckout.checked = false;
            activeWorkers.forEach(worker => {
                const item = document.createElement('label');
                item.className = 'flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer';
                item.innerHTML = `<input type="checkbox" name="early-checkout-workers" value="${worker.id}" class="h-4 w-4 text-orange-600 rounded"><span class="ml-3 text-gray-700">${worker.name}</span>`;
                earlyCheckoutWorkerList.appendChild(item);
            });
            toggleModal(earlyCheckoutModal, true);
        });
        cancelEarlyCheckoutBtn.addEventListener('click', () => { toggleModal(earlyCheckoutModal, false); earlyCheckoutForm.reset(); });
        selectAllEarlyCheckout.addEventListener('change', (e) => {
            document.querySelectorAll('#early-checkout-worker-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            passwordIcon.className = isPassword ? 'ph ph-eye-slash' : 'ph ph-eye';
        });
        managementBtn.addEventListener('click', () => {
            pendingAction = { type: 'management' };
            passwordTitle.textContent = "Acceso a Gerencia";
            toggleModal(passwordModal, true);
        });
        closeManagementBtn.addEventListener('click', () => toggleModal(managementModal, false));
        
        auth.onAuthStateChanged(user => { if (user) { currentUserId = user.uid; userIdEl.textContent = currentUserId.substring(0, 8); listenToWorkers(); } });
        
        async function authenticateUser() {
            try { await signInAnonymously(auth); } catch (error) {
                console.error("Authentication Error:", error);
                if (error.code === 'auth/configuration-not-found') {
                     showAlert( 'Error de Configuración de Firebase', 'El inicio de sesión anónimo no está habilitado. Ve a tu Consola de Firebase > Authentication > Sign-in method y activa el proveedor "Anónimo".', 'error');
                } else { showAlert('Error de Autenticación', 'No se pudo conectar.', 'error'); }
            }
        }
        
        function listenToWorkers() {
            const workersCollection = collection(db, `artifacts/${appId}/public/data/workers`);
            onSnapshot(workersCollection, (snapshot) => { 
                loadingRow.style.display = 'none'; 
                workersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWorkersTable();
            }, (error) => { console.error(error); showAlert('Error', 'No se pudo obtener la lista.', 'error'); });
        }

        async function renderWorkersTable() {
            const checkedIds = new Set(Array.from(document.querySelectorAll('.worker-checkbox:checked')).map(cb => cb.dataset.id));
            workersTableBody.innerHTML = '';
            if (workersData.length === 0) { workersTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8"><div class="text-gray-500"><i class="ph ph-users text-4xl mb-2"></i><p class="font-semibold">No hay personal.</p></div></td></tr>`; return; }
            const sortedWorkers = [...workersData].sort((a, b) => a.name.localeCompare(b.name));
            for (const [index, worker] of sortedWorkers.entries()) {
                const row = document.createElement('tr');
                const isChecked = checkedIds.has(worker.id) ? 'checked' : '';
                row.dataset.workerId = worker.id;
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="worker-checkbox w-4 h-4 text-blue-600 rounded" data-id="${worker.id}" ${isChecked}></td>
                    <td class="px-4 py-4 font-medium text-gray-900 whitespace-nowrap">${worker.name}<div class="text-xs text-gray-500">${worker.dni || 'N/A'}</div></td>
                    <td class="px-4 py-3">${worker.role}</td>
                    <td class="px-4 py-3 text-center font-mono text-base daily-duration-cell">00:00</td>
                    <td class="px-4 py-3 text-center font-mono text-base total-duration-cell">00:00</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(worker.hourlyRate)}</td>
                    <td class="px-4 py-3 text-right font-bold text-blue-600 pay-cell">${formatCurrency(0)}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <button class="edit-worker-btn text-blue-500 hover:text-blue-700" data-id="${worker.id}" title="Editar Obrero"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button class="delete-worker-btn text-red-500 hover:text-red-700" data-id="${worker.id}" title="Eliminar Obrero"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </td>`;
                workersTableBody.appendChild(row);
                await updateWorkerRow(worker.id);
            }
        }
        
        async function updateWorkerRow(workerId) {
            const worker = workersData.find(w => w.id === workerId);
            const row = workersTableBody.querySelector(`tr[data-worker-id="${workerId}"]`);
            if (!worker || !row) return;

            const now = new Date();
            const todayStr = dateToYYYYMMDD(now);
            let totalWorkDuration = worker.totalWorkSeconds || 0;
            
            const dailyRecord = await getOrCreateDailyRecord(workerId, todayStr);
            let dailyWorkSeconds = dailyRecord.workSeconds || 0;
            
            if (worker.checkedIn && worker.lastCheckInTime) {
                const sessionSeconds = (now.getTime() - worker.lastCheckInTime.toDate().getTime()) / 1000;
                totalWorkDuration += sessionSeconds;
                dailyWorkSeconds += sessionSeconds;
                row.className = 'bg-green-100 border-b status-pulse';
            } else {
                row.className = workersData.findIndex((w, i) => w.id === workerId) % 2 === 0 ? 'bg-white border-b' : 'bg-gray-50 border-b';
            }
            
            const totalPay = (totalWorkDuration / 3600) * (worker.hourlyRate || 0);
            
            row.querySelector('.daily-duration-cell').textContent = formatTime(dailyWorkSeconds);
            row.querySelector('.total-duration-cell').textContent = formatTime(totalWorkDuration);
            row.querySelector('.pay-cell').textContent = formatCurrency(totalPay);
        }

        function updateGrandTotal() {
            const now = new Date();
            let grandTotal = 0;
            workersData.forEach(worker => {
                let workDuration = worker.totalWorkSeconds || 0;
                if (worker.checkedIn && worker.lastCheckInTime) {
                    workDuration += (now.getTime() - worker.lastCheckInTime.toDate().getTime()) / 1000;
                }
                grandTotal += (workDuration / 3600) * (worker.hourlyRate || 0);
            });
            grandTotalDisplay.textContent = formatCurrency(grandTotal);
        }

        async function getOrCreateDailyRecord(workerId, dateStr) {
            if (dailyRecordsCache[workerId] && dailyRecordsCache[workerId][dateStr]) {
                return dailyRecordsCache[workerId][dateStr];
            }

            const recordRef = doc(db, `artifacts/${appId}/public/data/workers/${workerId}/dailyRecords`, dateStr);
            let recordSnap = await getDoc(recordRef);
            let data;
            if (!recordSnap.exists()) {
                data = { date: dateStr, workSeconds: 0 };
                await setDoc(recordRef, data);
            } else {
                data = recordSnap.data();
            }

            if (!dailyRecordsCache[workerId]) dailyRecordsCache[workerId] = {};
            dailyRecordsCache[workerId][dateStr] = data;
            return data;
        }

        checkInBtn.addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.worker-checkbox:checked');
            if (checkedBoxes.length === 0) return showAlert('Atención', 'Selecciona al menos un obrero.', 'info');
            
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            const now = new Date();
            
            for (const id of selectedIds) {
                const worker = workersData.find(w => w.id === id);
                if (worker && !worker.checkedIn) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/workers`, id), {
                        checkedIn: true, lastCheckInTime: Timestamp.fromDate(now)
                    });
                }
            }
            showAlert('Éxito', `Ingreso registrado para ${selectedIds.length} obrero(s).`, 'success');
            document.querySelectorAll('.worker-checkbox:checked').forEach(cb => cb.checked = false);
            selectAllCheckbox.checked = false;
        });
        
        async function completeShift(workerId, checkoutTime) {
             const workerRef = doc(db, `artifacts/${appId}/public/data/workers`, workerId);
             const workerDoc = await getDoc(workerRef);
             if(!workerDoc.exists() || !workerDoc.data().checkedIn) return;
             
             const worker = workerDoc.data();
             const now = checkoutTime ? checkoutTime.toDate() : new Date();
             const sessionSeconds = (now.getTime() - worker.lastCheckInTime.toDate().getTime()) / 1000;
             const newTotalWorkSeconds = (worker.totalWorkSeconds || 0) + sessionSeconds;
             
             const todayStr = dateToYYYYMMDD(now);
             const dailyRecordRef = doc(db, `artifacts/${appId}/public/data/workers/${workerId}/dailyRecords`, todayStr);
             const dailyRecord = await getOrCreateDailyRecord(workerId, todayStr);
             const newDailyWorkSeconds = (dailyRecord.workSeconds || 0) + sessionSeconds;
             
             await updateDoc(workerRef, { checkedIn: false, lastCheckInTime: null, totalWorkSeconds: newTotalWorkSeconds });
             await setDoc(dailyRecordRef, { workSeconds: newDailyWorkSeconds, date: todayStr }, { merge: true });
        }
        
        earlyCheckoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(earlyCheckoutForm);
            const selectedIds = formData.getAll('early-checkout-workers');
            const reason = formData.get('checkout-reason').trim();
            if (selectedIds.length === 0 || !reason) return showAlert('Error', 'Debes seleccionar obrero(s) y un motivo.', 'error');
            
            for (const id of selectedIds) {
                await completeShift(id);
                await updateDoc(doc(db, `artifacts/${appId}/public/data/workers`, id), {
                    earlyDepartures: arrayUnion({ reason, date: Timestamp.now() }) 
                });
            }
            toggleModal(earlyCheckoutModal, false);
            earlyCheckoutForm.reset(); 
            showAlert('Éxito', `Salida anticipada registrada.`, 'success');
            document.querySelectorAll('#early-checkout-worker-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            selectAllEarlyCheckout.checked = false;
        });

        async function handleDailyProcesses() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            const morningCheckout = hours === 11 && minutes === 30 && !dailyProcessFlags.morning;
            const eveningCheckout = hours === 18 && minutes === 0 && !dailyProcessFlags.evening;

            if (morningCheckout || eveningCheckout) {
                const checkoutTime = Timestamp.fromDate(new Date(now.setMinutes(morningCheckout ? 30 : 0, 0, 0)));
                for(const worker of workersData) {
                    if(worker.checkedIn) await completeShift(worker.id, checkoutTime);
                }
                if (morningCheckout) dailyProcessFlags.morning = true;
                if (eveningCheckout) dailyProcessFlags.evening = true;
            }

            if (hours === 0 && (dailyProcessFlags.morning || dailyProcessFlags.evening)) {
                 dailyProcessFlags = { morning: false, evening: false };
                 console.log("Flags de checkout reiniciadas.");
            }
        }
        
        addWorkerForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const fd = new FormData(addWorkerForm); 
            const newWorker = { name: fd.get('name'), role: fd.get('role'), dni: fd.get('dni'), email: fd.get('email'), hourlyRate: parseFloat(fd.get('hourlyRate')), checkedIn: false, lastCheckInTime: null, totalWorkSeconds: 0, accumulatedLateMinutes: 0, earlyDepartures: [], createdAt: serverTimestamp() }; 
            try { 
                // ESTA FUNCIÓN ESTABA CORRECTA Y YA USABA addDoc.
                await addDoc(collection(db, `artifacts/${appId}/public/data/workers`), newWorker); 
                showAlert('Éxito', `${newWorker.name} ha sido agregado.`, 'success'); 
                toggleModal(addWorkerModal, false); addWorkerForm.reset(); 
            } catch (err) { console.error(err); showAlert('Error', 'No se pudo agregar al obrero. Revisa los permisos de Firebase.', 'error'); } 
        });

        editWorkerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const workerId = el('edit-worker-id').value;
            const updatedData = { name: el('edit-name').value, role: el('edit-role').value, dni: el('edit-dni').value, email: el('edit-email').value, hourlyRate: parseFloat(el('edit-hourlyRate').value) };
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/workers`, workerId), updatedData);
                showAlert('Éxito', 'Los datos han sido actualizados.', 'success');
                toggleModal(editWorkerModal, false);
            } catch (err) { console.error(err); showAlert('Error', 'No se pudieron actualizar los datos.', 'error'); }
        });

        adjustmentDetailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const workerId = el('adjust-detail-worker-id').value;
            const dateStr = el('adjustment-date-selector').value;
            if (!dateStr) return showAlert('Error', 'Debe seleccionar una fecha.', 'error');
            
            const hoursInput = el('adjust-hours-day').value;
            const timeParts = hoursInput.split(':');
            const hours = parseInt(timeParts[0], 10) || 0;
            const minutes = parseInt(timeParts[1], 10) || 0;
            const newDailyWorkSeconds = (hours * 3600) + (minutes * 60);

            const newAccumulatedLateMinutes = parseInt(el('adjust-lateness').value, 10) || 0;

            try {
                await runTransaction(db, async (transaction) => {
                    const workerRef = doc(db, `artifacts/${appId}/public/data/workers`, workerId);
                    const dailyRecordRef = doc(db, `artifacts/${appId}/public/data/workers/${workerId}/dailyRecords`, dateStr);
                    
                    const workerDoc = await transaction.get(workerRef);
                    if (!workerDoc.exists()) throw "Worker not found!";
                    const dailyDocSnap = await transaction.get(dailyRecordRef);
                    const oldDailyWorkSeconds = dailyDocSnap.exists() ? (dailyDocSnap.data().workSeconds || 0) : 0;
                    
                    const workSecondsDelta = newDailyWorkSeconds - oldDailyWorkSeconds;
                    const newTotalWorkSeconds = (workerDoc.data().totalWorkSeconds || 0) + workSecondsDelta;
                    
                    transaction.update(workerRef, {
                        totalWorkSeconds: newTotalWorkSeconds,
                        accumulatedLateMinutes: newAccumulatedLateMinutes,
                    });
                    transaction.set(dailyRecordRef, { workSeconds: newDailyWorkSeconds, date: dateStr }, { merge: true });
                });
                
                showAlert('Éxito', 'El registro ha sido ajustado correctamente.', 'success');
                toggleModal(adjustmentDetailModal, false);
                toggleModal(managementModal, false); 
                
            } catch (err) {
                console.error("Error adjusting time:", err);
                showAlert('Error', 'No se pudo realizar el ajuste.', 'error');
            }
        });

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = el('password').value;
            if (password === 'GatoSandia@') {
                toggleModal(passwordModal, false);
                if (pendingAction.type === 'delete') {
                    const worker = workersData.find(w => w.id === pendingAction.workerId);
                    if (confirm(`¿Estás seguro de que quieres eliminar a ${worker.name}?`)) {
                        deleteDoc(doc(db, `artifacts/${appId}/public/data/workers`, pendingAction.workerId))
                            .then(() => showAlert('Eliminado', `${worker.name} fue eliminado.`, 'success'))
                            .catch(() => showAlert('Error', 'No se pudo eliminar. Revisa los permisos.', 'error'));
                    }
                } else if (pendingAction.type === 'edit') {
                    const worker = workersData.find(w => w.id === pendingAction.workerId);
                    el('edit-worker-id').value = worker.id;
                    el('edit-name').value = worker.name;
                    el('edit-role').value = worker.role;
                    el('edit-dni').value = worker.dni;
                    el('edit-email').value = worker.email;
                    el('edit-hourlyRate').value = worker.hourlyRate;
                    toggleModal(editWorkerModal, true);
                } else if (pendingAction.type === 'management') {
                    openManagementPanel();
                }
            } else {
                showAlert('Error', 'Contraseña incorrecta.', 'error');
            }
            passwordForm.reset();
            passwordInput.type = 'password';
            passwordIcon.className = 'ph ph-eye';
            pendingAction = { type: null, workerId: null };
        });

        function openManagementPanel() {
            managementWorkerList.innerHTML = '';
            adjustSelectedBtn.disabled = true;
            const sortedWorkers = [...workersData].sort((a,b) => a.name.localeCompare(b.name));
            sortedWorkers.forEach(worker => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="management-selection" class="management-checkbox h-5 w-5 text-red-600" data-id="${worker.id}">
                        <div>
                            <p class="font-semibold">${worker.name}</p>
                            <p class="text-xs text-gray-500">Horas: ${formatTime(worker.totalWorkSeconds || 0)} | Retraso: ${worker.accumulatedLateMinutes || 0} min</p>
                        </div>
                    </div>
                `;
                managementWorkerList.appendChild(item);
            });
            toggleModal(managementModal, true);
        }
        
        managementWorkerList.addEventListener('change', () => {
            const selectedCount = managementWorkerList.querySelectorAll('.management-checkbox:checked').length;
            adjustSelectedBtn.disabled = selectedCount !== 1;
        });

        adjustSelectedBtn.addEventListener('click', async () => {
            const selectedCheckbox = managementWorkerList.querySelector('.management-checkbox:checked');
            if(selectedCheckbox) {
                const workerId = selectedCheckbox.dataset.id;
                const worker = workersData.find(w => w.id === workerId);
                el('adjust-detail-worker-id').value = workerId;
                el('adjust-detail-worker-name').textContent = worker.name;

                const recordsRef = collection(db, `artifacts/${appId}/public/data/workers/${workerId}/dailyRecords`);
                const recordsSnap = await getDocs(recordsRef);
                const dates = new Set(recordsSnap.docs.map(doc => doc.id));
                
                const todayStr = dateToYYYYMMDD(new Date());
                dates.add(todayStr);
                
                const sortedDates = Array.from(dates).sort().reverse();
                
                adjustmentDateSelector.innerHTML = '<option value="">Seleccione una fecha...</option>';
                sortedDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    if (date === todayStr) {
                        option.selected = true;
                    }
                    adjustmentDateSelector.appendChild(option);
                });
                
                adjustmentDetailForm.reset();
                el('adjust-lateness').value = worker.accumulatedLateMinutes || 0;
                
                await adjustmentDateSelector.dispatchEvent(new Event('change'));

                toggleModal(adjustmentDetailModal, true);
            }
        });
        
        adjustmentDateSelector.addEventListener('change', async (e) => {
            const dateStr = e.target.value;
            const workerId = el('adjust-detail-worker-id').value;
            if(!dateStr || !workerId) return;
            const dailyRecord = await getOrCreateDailyRecord(workerId, dateStr);
            el('adjust-hours-day').value = formatTime(dailyRecord.workSeconds || 0);
        });
        
        workersTableBody.addEventListener('click', async (e) => { 
            const deleteBtn = e.target.closest('.delete-worker-btn');
            const editBtn = e.target.closest('.edit-worker-btn');
            if (deleteBtn) {
                pendingAction = { type: 'delete', workerId: deleteBtn.dataset.id };
                passwordTitle.textContent = "Confirmar Eliminación";
                toggleModal(passwordModal, true);
            }
            if (editBtn) {
                pendingAction = { type: 'edit', workerId: editBtn.dataset.id };
                passwordTitle.textContent = "Confirmar Edición";
                toggleModal(passwordModal, true);
            }
        });

        selectAllCheckbox.addEventListener('change', (e) => { document.querySelectorAll('.worker-checkbox').forEach(cb => cb.checked = e.target.checked); });
        
        async function generateReport() {
            try {
                const reportData = await fetchReportData(null, null); // Fetch all data
                currentReportData = { range: { startDate: null, endDate: null }, data: reportData, type: 'total' };
                generateVisualReport(reportData, null, null, 'total');
                toggleModal(reportModal, true);
            } catch(error) {
                console.error("Error generating report:", error);
                showAlert('Error', 'No se pudo generar el reporte.', 'error');
            }
        }

        async function fetchReportData(startDate, endDate) {
             const reportData = [];
             for (const worker of workersData) {
                 const recordsRef = collection(db, `artifacts/${appId}/public/data/workers/${worker.id}/dailyRecords`);
                 const recordsSnap = await getDocs(recordsRef);
                 const records = [];
                 recordsSnap.forEach(doc => {
                     const docDate = doc.id;
                     if (!startDate || (docDate >= startDate && docDate <= endDate)) {
                         records.push(doc.data());
                     }
                 });
                 if (records.length > 0) {
                     reportData.push({ workerInfo: worker, records: records.sort((a,b) => a.date.localeCompare(b.date)) });
                 }
             }
             return reportData;
        }
        
        function generateVisualReport(reportData, startDate, endDate, type) {
            let dateText = 'Mostrando reporte con todos los datos históricos';
            reportDateRange.textContent = dateText;
            
            if (reportData.length === 0) {
                reportBody.innerHTML = '<p class="text-center text-gray-500 mt-8">No hay datos para generar un reporte.</p>';
                return;
            }

            let grandTotalPay = 0;
            const workerReports = reportData.map(item => {
                const { workerInfo, records } = item;
                
                let periodWorkSeconds = 0;
                records.forEach(rec => periodWorkSeconds += (rec.workSeconds || 0));
                
                const periodPay = (periodWorkSeconds / 3600) * (workerInfo.hourlyRate || 0);
                grandTotalPay += periodPay;
                
                return `
                    <div class="p-4 border rounded-lg bg-gray-50 break-inside-avoid mb-4">
                        <h3 class="text-xl font-bold">${workerInfo.name}</h3>
                        <p class="text-sm text-gray-600 mb-4">${workerInfo.role} - DNI: ${workerInfo.dni || 'N/A'}</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div><p class="text-xs uppercase">Horas en Período</p><p class="text-2xl font-semibold">${formatTime(periodWorkSeconds)}</p></div>
                             <div><p class="text-xs uppercase">Minutos de Retraso (Total)</p><p class="text-2xl font-semibold">${workerInfo.accumulatedLateMinutes || 0}</p></div>
                            <div><p class="text-xs uppercase">Pago en Período</p><p class="text-2xl font-semibold text-green-600">${formatCurrency(periodPay)}</p></div>
                        </div>
                    </div>`;
            }).join('');

            const totalSummaryHTML = `
                <div class="p-6 mb-6 border-b-2 border-indigo-500 bg-indigo-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 text-center">Total a Pagar en Período</h3>
                    <p class="text-4xl font-bold text-indigo-600 text-center mt-2">${formatCurrency(grandTotalPay)}</p>
                </div>
            `;
            reportBody.innerHTML = totalSummaryHTML + `<div class="space-y-6">` + workerReports + `</div>`;
        }
        
        function generateAndDownloadCSV() {
            if (!currentReportData.data || currentReportData.data.length === 0) {
                return showAlert('Info', 'No hay datos en el reporte actual para descargar.', 'info');
            }
            const { range, data } = currentReportData;
            
            const headers = ["Fecha", "Obrero", "Horas del Día", "Pago del Día"];
            const rows = [];
            let grandTotalPay = 0;

            data.forEach(item => {
                item.records.forEach(record => {
                    const dailyPay = (record.workSeconds / 3600) * (item.workerInfo.hourlyRate || 0);
                    grandTotalPay += dailyPay;
                    rows.push([
                        `"${record.date}"`, `"${item.workerInfo.name}"`, 
                        (record.workSeconds / 3600).toFixed(2), dailyPay.toFixed(2)
                    ]);
                });
            });

            const summaryRows = [
                ["Reporte Desde", range.startDate || 'Inicio'],
                ["Reporte Hasta", range.endDate || 'Fin'],
                ["Costo Total del Periodo", grandTotalPay.toFixed(2)],
                []
            ];

            const allRows = [...summaryRows, headers, ...rows];
            const csvContent = allRows.map(e => e.join(",")).join("\n");
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const fileName = `reporte_${range.startDate || 'total'}_a_${range.endDate || ''}.csv`;
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 60000); 
            setInterval(() => {
                workersData.forEach(w => updateWorkerRow(w.id));
                updateGrandTotal();
            }, 1000);
            setInterval(handleDailyProcesses, 60000); 
            authenticateUser();
        });
    </script>
<script>
    // Script para registrar el Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registrado con éxito: ', registration.scope);
        }, err => {
          // Si da 404, es porque el archivo sw.js no existe.
          console.error('Fallo en el registro de ServiceWorker. (Asegúrate que /sw.js exista y sea accesible): ', err);
        });
      });
    }
</script>
</body>
</html>